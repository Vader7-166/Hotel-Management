@model Hotel_Management.Models.Booking
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = $"Booking Details #{Model.BookingId}";
    Layout = "~/Views/Shared/_LayoutCustomer.cshtml";

    // --- Tính toán t?ng ti?n ---
    var totalNights = (int)(Model.CheckOutDate.ToDateTime(TimeOnly.MinValue) - Model.CheckInDate.ToDateTime(TimeOnly.MinValue)).TotalDays;
    var roomSubtotal = Model.BookingDetails.Sum(d => d.SubTotal ?? 0);
    var serviceSubtotal = Model.ServiceUsages.Sum(s => s.TotalAmount ?? 0);
    var grandTotal = roomSubtotal + serviceSubtotal;

    // --- Xác ??nh màu tr?ng thái ---
    var statusClass = Model.Status switch
    {
        "Pending" => "bg-warning text-dark",
        "Confirmed" => "bg-success",
        "Cancelled" => "bg-danger",
        "Completed" => "bg-primary",
        _ => "bg-secondary"
    };
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="container mt-5 mb-5">
    <div class="card p-4 p-md-5 shadow-lg" style="border-radius: 10px; border: none;">

        <div class="row pb-3 border-bottom mb-4">
            <div class="col-md-6">
                <h3 class="fw-bold" style="color: #c19b51;">HANOI HOTEL</h3>
                <p class="mb-0 text-muted">Live Oriental Heritage</p>
            </div>
            <div class="col-md-6 text-md-end">
                <h4 class="fw-bold mb-2">Booking Confirmation</h4>
                <p class="mb-1"><strong>ID:</strong> #@Model.BookingId</p>
                <p class="mb-0"><strong>Status:</strong> <span class="badge fs-6 @statusClass">@Model.Status</span></p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <h5 class="fw-semibold">Billed To:</h5>
                @if (Model.Customer != null)
                {
                    <p class="mb-0">@Model.Customer.FullName</p>
                    <p class="mb-0">@Model.Customer.Email</p>
                }
                else
                {
                    <p class="mb-0 text-muted">Customer information not available.</p>
                }
            </div>
            <div class="col-md-6 text-md-end">
                <h5 class="fw-semibold">Booking Details:</h5>
                <p class="mb-0"><strong>Booking Date:</strong> @Model.BookingDate.ToString("dd/MM/yyyy")</p>
                <p class="mb-0"><strong>Check-in:</strong> @Model.CheckInDate.ToString("dd/MM/yyyy")</p>
                <p class="mb-0"><strong>Check-out:</strong> @Model.CheckOutDate.ToString("dd/MM/yyyy")</p>
                <p class="mb-0"><strong>Total Nights:</strong> @totalNights</p>
            </div>
        </div>

        <h5 class="fw-bold">Room Charges</h5>
        <div class="table-responsive mb-4">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Room Type</th>
                        <th>Room Number</th>
                        <th>Price/Night</th>
                        <th>Nights</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detail in Model.BookingDetails)
                    {
                        <tr>
                            <td>@detail.Room.RoomType.TypeName</td>
                            <td>@detail.Room.RoomNumber</td>
                            <td>@detail.UnitPrice.ToString("N0") VND</td>
                            <td>@detail.Nights</td>
                            <td class="text-end fw-semibold">@detail.SubTotal?.ToString("N0") VND</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (Model.ServiceUsages != null && Model.ServiceUsages.Any())
        {
            <h5 class="fw-bold mt-3">Services Charges</h5>
            <div class="table-responsive mb-4">
                <table class="table table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Service Name</th>
                            <th>Unit Price</th>
                            <th>Quantity</th>
                            <th>Usage Date</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var service in Model.ServiceUsages)
                        {
                            <tr>
                                <td>@service.Service.ServiceName</td>
                                <td>@service.UnitPrice.ToString("N0") VND</td>
                                <td>@service.Quantity</td>
                                <td>@service.UsageDate.ToString("dd/MM/yyyy")</td>
                                <td class="text-end fw-semibold">@service.TotalAmount?.ToString("N0") VND</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <hr />
            <p class="text-muted">No extra services were selected for this booking.</p>
        }

        <div class="row justify-content-end">
            <div class="col-md-5">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Room Subtotal:</span>
                    <span class="fw-semibold">@roomSubtotal.ToString("N0") VND</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Service Subtotal:</span>
                    <span class="fw-semibold">@serviceSubtotal.ToString("N0") VND</span>
                </div>
                <hr />
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="fw-bold fs-4">Grand Total:</span>
                    <span class="fw-bold fs-4 text-success">@grandTotal.ToString("N0") VND</span>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.Notes))
        {
            <hr />
            <h5 class="fw-bold">Notes</h5>
            <p class="text-muted fst-italic">"@Model.Notes"</p>
        }

        <hr />
        <div class="text-end d-flex justify-content-end gap-2 flex-wrap">
            <a asp-area="Customer" asp-controller="Booking" asp-action="MyBookings" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to My Bookings
            </a>
            <button onclick="window.print()" class="btn btn-primary">
                <i class="bi bi-printer"></i> Print Invoice
            </button>
            @if (Model.Status == "Pending")
            {
                <form asp-action="Cancel" asp-route-id="@Model.BookingId" method="post" onsubmit="return confirm('Are you sure you want to cancel this booking?');">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> Cancel Booking
                    </button>
                </form>
            }
        </div>
    </div>
</div>